name: DevOpsPro Europe ğŸ¤–ğŸ‡±ğŸ‡¹ğŸ‡ªğŸ‡º Network Services Delivery

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

jobs:
  check-out:
    runs-on: self-hosted
    steps:
    - name: Check out repository code
      uses: actions/checkout@v3

  inventory-lint:
    runs-on: self-hosted
    needs: check-out
    steps:
    - name: ğŸ—³ï¸ Lint inventory
      run: |
        make lint-inventory

  build-staging-env:
    runs-on: self-hosted
    needs: inventory-lint
    steps:
    - name: ğŸ› ï¸ Build staging env
      run: |
        make run-nso-node
        make load-neds
        make load-packages

  test:
    runs-on: self-hosted
    needs: build-staging-env
    steps:
    - name: ğŸ¤– Run tests
      env:
        ENVIRONMENT: test
        TEST_AUTH_HASH: ${{ secrets.TEST_AUTH_HASH }}
      run: |
        make prepare-test-network
        make run-tests

  create-artifact-test:
    runs-on: self-hosted
    needs: test
    if: always()
    steps:
    - name: ğŸ“¦ Generate artifacts
      env:
        ENVIRONMENT: test
      run: |
        make create-artifact-tests

    - name: ğŸ“¦ Upload tests artifact
      uses: actions/upload-artifact@v4
      with:
        name: devopsproeu_tests
        path: pipeline/preconfigs/devopsproeu_test.tar.gz

  commit:
    runs-on: self-hosted
    needs: create-artifact-test
    if: github.ref == 'refs/heads/main' && needs.test.result == 'success'
    steps:
    - name: âš¡ï¸ Commit inventory changes
      env:
        ENVIRONMENT: production
        PROD_AUTH_HASH: ${{ secrets.PROD_AUTH_HASH }}
      run: |
        make run-tests

  create-artifact-commit:
    runs-on: self-hosted
    needs: commit
    if: always()
    steps:
    - name: ğŸ“¦ Generate artifacts
      env:
        ENVIRONMENT: production
      run: |
        make create-artifact-tests

    - name: ğŸ“¦ Upload tests artifact
      uses: actions/upload-artifact@v4
      with:
        name: devopsproeu_commit
        path: pipeline/preconfigs/devopsproeu_commit.tar.gz

  release:
    runs-on: self-hosted
    needs: create-artifact-commit
    if: github.ref == 'refs/heads/main' && needs.test.result == 'success'
    steps:
      - name: â­ï¸ Get the latest tag
        id: get_latest_tag
        run: make get-current-release-tag
      - name: â­ï¸ Increment version
        id: increment_version
        run: make calculate-new-release-tag VERSION=${{ env.tag }}
      - name: â­ï¸ Create Release
        id: create_release
        uses: actions/create-release@v1.1.4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.new_version }}
          release_name: Release v.${{ env.new_version }}
          body: |
            ğŸ… Automated Inventory Release v.${{ env.new_version }} ğŸ…
          draft: false
          prerelease: false

      - name: â­ï¸ Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: pipeline/preconfigs/devopsproeu_commit.tar.gz
          asset_name: devopsproeu_commit.tar.gz
          asset_content_type: application/zip

  cleanup-staging-env:
    runs-on: self-hosted
    needs: create-artifact-test
    steps:
    - name: ğŸ§¹ Cleanup resources
      run: make clean